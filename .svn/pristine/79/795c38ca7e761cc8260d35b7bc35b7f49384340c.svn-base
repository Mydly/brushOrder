import CONSTS, {Login, CacheName, API, AlertType } from '../config/consts';
//import fetch from 'isomorphic-fetch';
import { req } from '../main/requests';
import { mem, alog } from '../function/common';

export const tabChangeAction = i => ({
  type: CONSTS.type.changeTab,
  item: i,
});

export const alertAction = (type, msg) => {
    return {
        type: type,
        msg: msg,
    }
};

export const changeTab = (i) =>{
    console.log('切换tab');
    console.log(i);
    return (dispatch) => {
      dispatch( tabChangeAction(i) );
    };
}

export const fun_change = (key) => {
    return (dispatch) => (dispatch) => {
        dispatch( tabChangeAction(key) );
    };
}

//export const loginAction = (username,password) => {
//    return (dispatch) => {
//        dispatch({type:Login.logining});
//        return fetch('http://ming.a.com/app/art/login')
//                .then(response => response.json())
//                .then(json => {
//                    dispatch ({type:Login.logined,res:json})
//                })
//    }
//}

export const loginAction = (username, password) => {
    return (dispatch) => {
        dispatch({type:Login.logining});
        art("登录中",AlertType.infoAlert)(dispatch);
        return req('app/login/submit','post',{
            "username":username,
            "password":password
        },(data)=>{
            if( data.status == 1 ){
                mem(CacheName.userid,data.info.ID);
                mem(CacheName.userToken,data.info.TOKEN);
                dispatch({type:Login.loginSuc,res:data.info});

                alog('get user info');
                dispatch({type:API.startGetUserInfo});
                art("获取用户信息中...")(dispatch);
                req("app/user/userinfo","get",{},(data2)=>{
                    if(data2.status == 1){
                        return dispatch({type:API.successGetUserInfo,res:data2.info.baseinfo})
                    }
                    else{

                        return dispatch({type:API.failGetUserInfo,res:data2.info});
                    }
                },true);
            }
            else {
               return dispatch({type:Login.loginFail,res:data.info});
            }
        });
    }
}

export const getUserInfo = () => {
    alog('get user info start');
    return (dispatch) => {
        alog('get user info');
        dispatch({type:API.startGetUserInfo});
        req("app/user/userinfo","get",{},(data2)=>{
            if(data2.status == 1){
                return dispatch({type:API.successGetUserInfo,res:data2.info})
            }
            else{

                return dispatch({type:API.failGetUserInfo,res:data2.info});
            }
        },true);
    };
}

export const art = ( msg, type = AlertType.infoAlert, time = 3000 ) =>{
    return (dispatch) =>{
        setTimeout(()=>{
            dispatch({
                type:AlertType.cancelAlert
            })
        },time);
        return dispatch({
            type:type,
            obj:{msg:msg,time:time}
        });
    }
}

export const getMyfinan = () => {

    return (dispatch) => {
        req("app/user/finan","post",{},(data)=>{
            if(data.status == 1){
                return dispatch({type:CONSTS.api.successGetMyFinan,res:data.info})
            }
            else{
                return dispatch({type:CONSTS.api.failGetMyFinan,res:data.info});
            }
        },true)
    }
}

export const changeFinanChargeTab = (tabIndex) => {
    return {
        type:CONSTS.chageTabFinan.charge,
        item:tabIndex
    }
}

export default {
    art:art,
    changeTab:changeTab,
    changeFinanChargeTab:changeFinanChargeTab
};